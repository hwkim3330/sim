!function(t){"use strict";const e={IY:[270,2290,3010,3500,60,90,150,200,120,!0],IH:[390,1990,2550,3500,60,90,150,200,100,!0],EH:[530,1840,2480,3500,60,90,150,200,100,!0],EY:[440,2100,2600,3500,60,90,150,200,140,!0],AE:[660,1720,2410,3500,60,90,150,200,120,!0],AA:[730,1090,2440,3500,60,90,150,200,120,!0],AO:[570,840,2410,3500,60,90,150,200,120,!0],OW:[490,1350,2400,3500,60,90,150,200,140,!0],UH:[440,1020,2240,3500,60,90,150,200,100,!0],UW:[300,870,2240,3500,60,90,150,200,120,!0],AH:[640,1190,2390,3500,60,90,150,200,100,!0],AX:[500,1500,2500,3500,60,90,150,200,60,!0],ER:[490,1350,1690,3500,60,90,150,200,120,!0],AY:[730,1090,2440,3500,60,90,150,200,180,!0],AW:[730,1090,2440,3500,60,90,150,200,180,!0],OY:[570,840,2410,3500,60,90,150,200,180,!0],B:[200,1100,2150,3500,60,90,150,200,60,!0],D:[200,1600,2600,3500,60,90,150,200,60,!0],G:[200,1990,2850,3500,60,90,150,200,60,!0],P:[200,1100,2150,3500,200,200,200,200,80,!1],T:[200,1600,2600,3500,200,200,200,200,80,!1],K:[200,1990,2850,3500,200,200,200,200,80,!1],V:[220,1100,2080,3500,60,90,150,200,80,!0],DH:[200,1600,2600,3500,60,90,150,200,60,!0],Z:[200,1600,2600,3500,60,90,150,200,80,!0],ZH:[200,1900,2500,3500,60,90,150,200,80,!0],F:[220,1100,2080,3500,200,200,200,200,100,!1],TH:[200,1600,2600,3500,200,200,200,200,80,!1],S:[200,1600,2600,3500,200,200,200,200,100,!1],SH:[200,1900,2500,3500,200,200,200,200,100,!1],HH:[500,1500,2500,3500,200,200,200,200,60,!1],CH:[200,1900,2500,3500,200,200,200,200,120,!1],JH:[200,1900,2500,3500,60,90,150,200,100,!0],M:[270,1e3,2200,3500,60,90,150,200,80,!0],N:[270,1600,2600,3500,60,90,150,200,80,!0],NG:[270,1990,2850,3500,60,90,150,200,80,!0],L:[310,1050,2880,3500,60,90,150,200,80,!0],R:[310,1060,1380,3500,60,90,150,200,80,!0],W:[290,610,2150,3500,60,90,150,200,60,!0],Y:[260,2070,3020,3500,60,90,150,200,60,!0],SIL:[0,0,0,0,200,200,200,200,50,!1],PAU:[0,0,0,0,200,200,200,200,150,!1],KA:[800,1200,2600,3500,60,90,150,200,120,!0],KEO:[600,1e3,2400,3500,60,90,150,200,120,!0],KO:[500,900,2400,3500,60,90,150,200,120,!0],KU:[350,800,2300,3500,60,90,150,200,120,!0],KEU:[400,1500,2400,3500,60,90,150,200,120,!0],KI:[300,2300,3e3,3500,60,90,150,200,120,!0],KAE:[600,1800,2600,3500,60,90,150,200,120,!0],KE:[500,1900,2600,3500,60,90,150,200,120,!0],KOE:[450,1600,2500,3500,60,90,150,200,140,!0],KWI:[350,1800,2600,3500,60,90,150,200,140,!0],KYA:[750,1300,2600,3500,60,90,150,200,140,!0],KYEO:[550,1100,2400,3500,60,90,150,200,140,!0],KYO:[450,1e3,2400,3500,60,90,150,200,140,!0],KYU:[350,900,2300,3500,60,90,150,200,140,!0],KWA:[700,1100,2500,3500,60,90,150,200,140,!0],KWO:[550,950,2400,3500,60,90,150,200,140,!0],KWAE:[600,1700,2600,3500,60,90,150,200,140,!0],KWE:[500,1800,2600,3500,60,90,150,200,140,!0],KUI:[400,1600,2500,3500,60,90,150,200,140,!0],KG:[200,1800,2700,3500,60,90,150,200,70,!0],KD:[200,1700,2600,3500,60,90,150,200,70,!0],KB:[200,1e3,2100,3500,60,90,150,200,70,!0],KJ:[200,2e3,2800,3500,60,90,150,200,80,!0],KK:[200,1900,2800,3500,200,200,200,200,90,!1],KT:[200,1700,2600,3500,200,200,200,200,90,!1],KP:[200,1e3,2100,3500,200,200,200,200,90,!1],KCH:[200,2100,2900,3500,200,200,200,200,100,!1],KH:[500,1500,2500,3500,200,200,200,200,70,!1],KGG:[200,1850,2750,3500,100,120,150,200,80,!0],KDD:[200,1750,2650,3500,100,120,150,200,80,!0],KBB:[200,1050,2150,3500,100,120,150,200,80,!0],KJJ:[200,2050,2850,3500,100,120,150,200,90,!0],KSS:[200,1700,2600,3500,150,150,150,200,90,!1],KS:[200,1600,2600,3500,200,200,200,200,90,!1],KN:[270,1600,2600,3500,60,90,150,200,80,!0],KM:[270,1e3,2200,3500,60,90,150,200,80,!0],KNG:[270,1900,2800,3500,60,90,150,200,80,!0],KL:[310,1100,2800,3500,60,90,150,200,70,!0]},s={the:["DH","AX"],a:["AX"],and:["AE","N","D"],to:["T","UW"],of:["AH","V"],in:["IH","N"],is:["IH","Z"],it:["IH","T"],you:["Y","UW"],that:["DH","AE","T"],he:["HH","IY"],was:["W","AA","Z"],for:["F","AO","R"],on:["AA","N"],are:["AA","R"],with:["W","IH","DH"],as:["AE","Z"],be:["B","IY"],at:["AE","T"],one:["W","AH","N"],have:["HH","AE","V"],this:["DH","IH","S"],from:["F","R","AH","M"],or:["AO","R"],by:["B","AY"],not:["N","AA","T"],but:["B","AH","T"],what:["W","AH","T"],all:["AO","L"],we:["W","IY"],when:["W","EH","N"],your:["Y","AO","R"],can:["K","AE","N"],there:["DH","EH","R"],use:["Y","UW","Z"],she:["SH","IY"],do:["D","UW"],how:["HH","AW"],if:["IH","F"],will:["W","IH","L"],up:["AH","P"],about:["AX","B","AW","T"],out:["AW","T"],so:["S","OW"],some:["S","AH","M"],would:["W","UH","D"],make:["M","EY","K"],like:["L","AY","K"],time:["T","AY","M"],just:["JH","AH","S","T"],know:["N","OW"],good:["G","UH","D"],people:["P","IY","P","AX","L"],hello:["HH","AX","L","OW"],world:["W","ER","L","D"],welcome:["W","EH","L","K","AH","M"],aperture:["AE","P","ER","CH","ER"],science:["S","AY","AX","N","S"],enrichment:["EH","N","R","IH","CH","M","AX","N","T"],center:["S","EH","N","T","ER"],testing:["T","EH","S","T","IH","NG"],test:["T","EH","S","T"],subject:["S","AH","B","JH","EH","K","T"],cake:["K","EY","K"],lie:["L","AY"],alive:["AX","L","AY","V"],still:["S","T","IH","L"],doing:["D","UW","IH","NG"],robot:["R","OW","B","AA","T"],computer:["K","AH","M","P","Y","UW","T","ER"],error:["EH","R","ER"],system:["S","IH","S","T","AX","M"],please:["P","L","IY","Z"],thank:["TH","AE","NG","K"],sorry:["S","AA","R","IY"],goodbye:["G","UH","D","B","AY"]},i={a:["AE"],b:["B"],c:["K"],d:["D"],e:["EH"],f:["F"],g:["G"],h:["HH"],i:["IH"],j:["JH"],k:["K"],l:["L"],m:["M"],n:["N"],o:["AA"],p:["P"],q:["K"],r:["R"],s:["S"],t:["T"],u:["AH"],v:["V"],w:["W"],x:["K","S"],y:["Y"],z:["Z"]},n={th:["TH"],sh:["SH"],ch:["CH"],ph:["F"],wh:["W"],ng:["NG"],ck:["K"],ee:["IY"],ea:["IY"],oo:["UW"],ou:["AW"],ow:["OW"],oi:["OY"],oy:["OY"],ai:["EY"],ay:["EY"],ie:["IY"],ey:["IY"],qu:["K","W"]},o=["KG","KGG","KN","KD","KDD","KL","KM","KB","KBB","KS","KSS",null,"KJ","KJJ","KCH","KK","KT","KP","KH"],a=["KA","KAE","KYA","KYAE","KEO","KE","KYEO","KYE","KO","KWA","KWAE","KOE","KYO","KU","KWO","KWE","KWI","KYU","KEU","KUI","KI"],r=[null,"KG","KGG","KG","KN","KN","KN","KD","KL","KL","KL","KL","KL","KL","KL","KL","KM","KB","KB","KS","KSS","KNG","KJ","KCH","KK","KT","KP","KH"],h={KYAE:["Y","KAE"],KYE:["Y","KE"]};function c(t){const e=t.charCodeAt(0);return e>=44032&&e<=55203}function u(t){const e=t.charCodeAt(0);return e>=44032&&e<=55203||e>=12593&&e<=12643}function l(t){const e=t.charCodeAt(0)-44032;if(e<0||e>11171)return null;return{cho:Math.floor(e/588),jung:Math.floor(e%588/28),jong:e%28}}function f(t){if(function(t){for(let e=0;e<t.length;e++)if(u(t[e]))return!0;return!1}(t)){const e=function(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s];if(" "===i||"\n"===i||"\t"===i){e.push("SIL");continue}if(/[.,!?;:]/.test(i)){e.push("PAU");continue}if(!c(i))continue;const n=l(i);if(!n)continue;const{cho:u,jung:f,jong:p}=n,d=o[u];d&&e.push(d);const K=a[f];if(K&&(h[K]?e.push(...h[K]):e.push(K)),p>0){const t=r[p];t&&e.push(t)}}return e}(t);return e.length&&"PAU"!==e[e.length-1]&&e.push("PAU"),e}const e=t.toLowerCase().replace(/[^a-z\s.,!?']/g,"").split(/\s+/),i=[];for(const t of e)t&&(t.match(/^[.,!?;:]+$/)?i.push("PAU"):(s[t]?i.push(...s[t]):i.push(...p(t)),i.push("SIL")));return i.length&&"PAU"!==i[i.length-1]&&i.push("PAU"),i}function p(t){const e=[];let s=0;for(;s<t.length;){if("'"===t[s]){s++;continue}let o=!1;for(const[i,a]of Object.entries(n))if(t.substr(s,i.length)===i){e.push(...a),s+=i.length,o=!0;break}if(o)continue;const a=t[s];i[a]&&("c"===a&&s+1<t.length&&"eiy".includes(t[s+1])?e.push("S"):"g"===a&&s+1<t.length&&"eiy".includes(t[s+1])?e.push("JH"):"e"===a&&s===t.length-1||e.push(...i[a])),s++}return e}class d{constructor(t){this.sampleRate=t,this.T=1/t,this.piT=Math.PI*this.T,this.twoPiT=2*Math.PI*this.T,this.a=0,this.b=0,this.c=0,this.y1=0,this.y2=0,this._lastFreq=-1,this._lastBw=-1}setParams(t,e){if(t===this._lastFreq&&e===this._lastBw)return;if(this._lastFreq=t,this._lastBw=e,t<=0)return this.a=0,this.b=0,void(this.c=0);const s=Math.exp(-this.piT*e),i=Math.cos(this.twoPiT*t);this.c=-s*s,this.b=2*s*i,this.a=1-this.b-this.c}process(t){const e=this.a*t+this.b*this.y1+this.c*this.y2;return this.y2=this.y1,this.y1=e,e}reset(){this.y1=0,this.y2=0,this._lastFreq=-1,this._lastBw=-1}}class K{constructor(t){this.sampleRate=t,this.phase=0,this.t0=0,this.openQuota=.7}setF0(t){this.t0=t>0?this.sampleRate/t:0}generate(){if(this.t0<=0)return 0;const t=this.phase/this.t0;let e;if(t<this.openQuota){const s=t/this.openQuota;e=3*s*s-2*s*s*s}else if(t<this.openQuota+.1){e=1-(t-this.openQuota)/.1}else e=0;return this.phase+=1,this.phase>=this.t0&&(this.phase-=this.t0),e}reset(){this.phase=0}}class m{constructor(t=22050){this.sampleRate=t,this.frameMs=10,this.samplesPerFrame=Math.floor(t*this.frameMs/1e3),this.glottal=new K(t),this.r1=new d(t),this.r2=new d(t),this.r3=new d(t),this.r4=new d(t),this.radPrev=0,this._frameBuffer=new Float64Array(this.samplesPerFrame)}synthesize(t,e){const s=[];let i=0;const n=t.reduce((t,e)=>t+Math.max(1,Math.floor(e.duration/this.frameMs)),0);for(let o=0;o<t.length;o++){const a=t[o],r=t[o+1]||null,h=Math.max(1,Math.floor(a.duration/this.frameMs));for(let t=0;t<h;t++){const o=t/h,c=this.interpolate(a,r,o),u=e.pitch*(1-i/n*.1),l=1+.02*(Math.random()-.5)*e.roughness;c.f0=u*l;const f=this.synthesizeFrame(c,e);s.push(...f),i++}}return this.normalize(s)}interpolate(t,e,s){const i=(t,e,s)=>t+(e-t)*s,n={f0:t.f0,f1:t.f1,f2:t.f2,f3:t.f3,f4:t.f4,b1:t.b1,b2:t.b2,b3:t.b3,b4:t.b4,voiced:t.voiced};if(e&&s>.7){const o=(s-.7)/.3;n.f1=i(t.f1,e.f1,o),n.f2=i(t.f2,e.f2,o),n.f3=i(t.f3,e.f3,o)}return n}synthesizeFrame(t,e){const s=this._frameBuffer,i=this.samplesPerFrame;this.r1.setParams(t.f1,t.b1),this.r2.setParams(t.f2,t.b2),this.r3.setParams(t.f3,t.b3),this.r4.setParams(t.f4,t.b4),this.glottal.setF0(t.f0);const n=t.voiced?.7:0,o=t.voiced?.05+.2*e.breathiness:.3;for(let t=0;t<i;t++){let e=this.glottal.generate()*n;e+=(2*Math.random()-1)*o;let i=this.r1.process(e);i=this.r2.process(i),i=this.r3.process(i),i=this.r4.process(i);const a=i-this.radPrev;this.radPrev=.99*i,s[t]=a}return Array.from(s)}normalize(t){let e=0;for(let s=0;s<t.length;s++){const i=t[s]<0?-t[s]:t[s];i>e&&(e=i)}if(e>0){const s=.8/e;for(let e=0;e<t.length;e++)t[e]*=s}return t}reset(){this.glottal.reset(),this.r1.reset(),this.r2.reset(),this.r3.reset(),this.r4.reset(),this.radPrev=0}}const A={default:{name:"default",pitch:120,pitchRange:20,speed:1,breathiness:0,roughness:.1},male:{name:"male",pitch:100,pitchRange:15,speed:1,breathiness:0,roughness:.1},female:{name:"female",pitch:180,pitchRange:30,speed:1,breathiness:.1,roughness:.05},robot:{name:"robot",pitch:100,pitchRange:0,speed:.9,breathiness:0,roughness:0},glados:{name:"glados",pitch:160,pitchRange:5,speed:.85,breathiness:0,roughness:0,effects:{ringMod:.15,formantShift:1.05,reverb:.3,bitcrush:0}}};class g{constructor(t){this.ctx=t}createChain(t,e,s){let i=t;if(s.ringMod>0){const t=this.createRingModulator(s.ringMod);i.connect(t.input),i=t.output}const n=this.createChorus();i.connect(n.input),i=n.output;const o=this.ctx.createDynamicsCompressor();if(o.threshold.value=-24,o.knee.value=30,o.ratio.value=12,o.attack.value=.003,o.release.value=.25,i.connect(o),i=o,s.reverb>0){const t=this.createReverb(s.reverb),e=this.ctx.createGain(),n=this.ctx.createGain();e.gain.value=1-.5*s.reverb,n.gain.value=.5*s.reverb,i.connect(e),i.connect(t),t.connect(n);const o=this.ctx.createGain();e.connect(o),n.connect(o),i=o}const a=this.createEQ();return i.connect(a),a.connect(e),t}createRingModulator(t){const e=this.ctx.createGain(),s=this.ctx.createGain(),i=this.ctx.createOscillator(),n=this.ctx.createGain();return i.type="sine",i.frequency.value=30,n.gain.value=t,i.connect(n),i.start(),e.connect(s),n.connect(s.gain),{input:e,output:s}}createChorus(){const t=this.ctx.createGain(),e=this.ctx.createGain(),s=this.ctx.createDelay(.05),i=this.ctx.createOscillator(),n=this.ctx.createGain();return s.delayTime.value=.005,i.frequency.value=.5,n.gain.value=.002,i.connect(n),n.connect(s.delayTime),i.start(),t.connect(e),t.connect(s),s.connect(e),{input:t,output:e}}createReverb(t){const e=this.ctx.createConvolver(),s=1.5*this.ctx.sampleRate,i=this.ctx.createBuffer(2,s,this.ctx.sampleRate);for(let t=0;t<2;t++){const e=i.getChannelData(t);for(let t=0;t<s;t++)e[t]=(2*Math.random()-1)*Math.exp(-t/(.1*s))}return e.buffer=i,e}createEQ(){const t=this.ctx.createBiquadFilter(),e=this.ctx.createBiquadFilter(),s=this.ctx.createBiquadFilter();t.type="highpass",t.frequency.value=200,t.Q.value=.7,e.type="lowpass",e.frequency.value=8e3,e.Q.value=.7,s.type="peaking",s.frequency.value=2e3,s.Q.value=1,s.gain.value=3,t.connect(s),s.connect(e);const i=this.ctx.createGain();return e.connect(i),t.output=i,t}}const H={TTS:class{constructor(t={}){this.voice=t.voice||A.default,this.sampleRate=t.sampleRate||22050,this.synthesizer=new m(this.sampleRate),this.audioContext=null,this.effects=null}async init(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:this.sampleRate}),this.effects=new g(this.audioContext)),"suspended"===this.audioContext.state&&await this.audioContext.resume()}setVoice(t){this.voice="string"==typeof t?A[t]||A.default:{...A.default,...t}}synthesize(t){const s=f(t).map(t=>{const s=e[t]||e.SIL;return{symbol:t,f1:s[0],f2:s[1],f3:s[2],f4:s[3],b1:s[4],b2:s[5],b3:s[6],b4:s[7],duration:Math.floor(s[8]/this.voice.speed),voiced:s[9],f0:this.voice.pitch}});return this.synthesizer.synthesize(s,this.voice)}async speak(t,e){await this.init();const s=this.synthesize(t),i=this.audioContext.createBuffer(1,s.length,this.sampleRate),n=i.getChannelData(0);for(let t=0;t<s.length;t++)n[t]=s[t];const o=this.audioContext.createBufferSource();return o.buffer=i,"glados"===this.voice.name&&this.voice.effects?this.effects.createChain(o,this.audioContext.destination,this.voice.effects):o.connect(this.audioContext.destination),new Promise(t=>{if(o.onended=t,o.start(),e){const t=s.length/this.sampleRate,i=this.audioContext.currentTime,n=()=>{const s=this.audioContext.currentTime-i,o=Math.min(1,s/t);e(o),o<1&&requestAnimationFrame(n)};requestAnimationFrame(n)}})}toWav(t){const e=this.synthesize(t);return this.samplesToWav(e)}async sing(t,s){await this.init();const i=[];for(let s=0;s<t.length;s++){const n=t[s],o=f(n.text),a=o.map(t=>{const s=e[t]||e.SIL,i=n.duration/o.length;return{symbol:t,f1:s[0],f2:s[1],f3:s[2],f4:s[3],b1:s[4],b2:s[5],b3:s[6],b4:s[7],duration:i,voiced:s[9],f0:n.pitch}}),r={...this.voice,pitch:n.pitch},h=this.synthesizer.synthesize(a,r);i.push(...h)}let n=0;for(let t=0;t<i.length;t++){const e=i[t]<0?-i[t]:i[t];e>n&&(n=e)}if(n>0){const t=.8/n;for(let e=0;e<i.length;e++)i[e]*=t}const o=i,a=this.audioContext.createBuffer(1,o.length,this.sampleRate),r=a.getChannelData(0);for(let t=0;t<o.length;t++)r[t]=o[t];const h=this.audioContext.createBufferSource();return h.buffer=a,"glados"===this.voice.name&&this.voice.effects?this.effects.createChain(h,this.audioContext.destination,this.voice.effects):h.connect(this.audioContext.destination),new Promise(t=>{if(h.onended=t,h.start(),s){const t=o.length/this.sampleRate,e=this.audioContext.currentTime,i=()=>{const n=this.audioContext.currentTime-e,o=Math.min(1,n/t);s(o),o<1&&requestAnimationFrame(i)};requestAnimationFrame(i)}})}download(t,e="speech.wav"){const s=this.toWav(t),i=new Blob([s],{type:"audio/wav"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=e,o.click(),URL.revokeObjectURL(n)}samplesToWav(t){const e=2*this.sampleRate,s=2*t.length,i=44+s,n=new ArrayBuffer(i),o=new DataView(n);this.writeString(o,0,"RIFF"),o.setUint32(4,i-8,!0),this.writeString(o,8,"WAVE"),this.writeString(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,this.sampleRate,!0),o.setUint32(28,e,!0),o.setUint16(32,2,!0),o.setUint16(34,16,!0),this.writeString(o,36,"data"),o.setUint32(40,s,!0);let a=44;for(const e of t){const t=Math.max(-1,Math.min(1,e));o.setInt16(a,Math.floor(32767*t),!0),a+=2}return n}writeString(t,e,s){for(let i=0;i<s.length;i++)t.setUint8(e+i,s.charCodeAt(i))}},Voice:A,textToPhonemes:f,PHONEMES:e,DAISY_BELL:[{text:"day",pitch:294,duration:400},{text:"zee",pitch:294,duration:400},{text:"day",pitch:392,duration:400},{text:"zee",pitch:330,duration:600},{text:"give",pitch:294,duration:300},{text:"me",pitch:330,duration:300},{text:"your",pitch:349,duration:300},{text:"an",pitch:330,duration:300},{text:"ser",pitch:294,duration:300},{text:"do",pitch:247,duration:600},{text:".",pitch:0,duration:400},{text:"im",pitch:294,duration:400},{text:"half",pitch:294,duration:400},{text:"cray",pitch:392,duration:400},{text:"zee",pitch:330,duration:600},{text:"all",pitch:294,duration:300},{text:"for",pitch:330,duration:300},{text:"the",pitch:349,duration:300},{text:"love",pitch:392,duration:400},{text:"of",pitch:349,duration:300},{text:"you",pitch:294,duration:800}],version:"2.0.0"};"undefined"!=typeof module&&module.exports?module.exports=H:"function"==typeof define&&define.amd?define(function(){return H}):t.SimiTTS=H}("undefined"!=typeof self?self:this);