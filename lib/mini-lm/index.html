<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Korean Mini LM - í•œêµ­ì–´ ë¯¸ë‹ˆ ì–¸ì–´ëª¨ë¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #252525;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --accent: #4a9eff;
      --accent-dim: #2a7edf;
      --success: #4caf50;
    }

    body {
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5em;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1.1em;
    }

    .panel {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .panel h2 {
      font-size: 1.2em;
      margin-bottom: 15px;
      color: var(--accent);
    }

    .model-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .info-card {
      background: var(--bg-tertiary);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .info-card .value {
      font-size: 1.8em;
      font-weight: bold;
      color: var(--accent);
    }

    .info-card .label {
      font-size: 0.85em;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    textarea, input[type="text"] {
      width: 100%;
      padding: 12px;
      background: var(--bg-tertiary);
      border: 1px solid #333;
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1em;
      font-family: inherit;
      resize: vertical;
    }

    textarea {
      min-height: 100px;
    }

    textarea:focus, input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: var(--accent-dim);
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
    }

    button.secondary {
      background: var(--bg-tertiary);
      border: 1px solid #444;
    }

    .slider-group {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    input[type="range"] {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      background: var(--bg-tertiary);
      border-radius: 3px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    .output {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 8px;
      min-height: 150px;
      white-space: pre-wrap;
      font-family: 'Noto Sans KR', monospace;
      line-height: 1.8;
    }

    .output.generating {
      border: 1px solid var(--accent);
    }

    .tokens-display {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 15px;
    }

    .token {
      background: var(--bg-tertiary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      font-family: monospace;
    }

    .token.special {
      background: var(--accent-dim);
      color: white;
    }

    .status {
      text-align: center;
      padding: 15px;
      color: var(--text-secondary);
    }

    .status.ready {
      color: var(--success);
    }

    footer {
      text-align: center;
      margin-top: 40px;
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      width: 0%;
      transition: width 0.3s;
    }

    .progress-text {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    .training-log {
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85em;
      color: var(--text-secondary);
      margin-top: 10px;
    }

    .training-log div {
      padding: 3px 0;
    }

    .training-log .loss {
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ‡°ğŸ‡· Korean Mini LM</h1>
      <p class="subtitle">ìëª¨ ê¸°ë°˜ í•œêµ­ì–´ ì–¸ì–´ëª¨ë¸ (Pure JavaScript)</p>
    </header>

    <div class="panel">
      <h2>ğŸ“Š ëª¨ë¸ ì •ë³´</h2>
      <div class="model-info">
        <div class="info-card">
          <div class="value" id="vocab-size">-</div>
          <div class="label">Vocabulary</div>
        </div>
        <div class="info-card">
          <div class="value" id="param-count">-</div>
          <div class="label">Parameters</div>
        </div>
        <div class="info-card">
          <div class="value" id="model-size">-</div>
          <div class="label">Model Size</div>
        </div>
        <div class="info-card">
          <div class="value" id="architecture">-</div>
          <div class="label">Architecture</div>
        </div>
      </div>
      <div class="status" id="status">Loading...</div>
    </div>

    <div class="panel">
      <h2>âœï¸ í…ìŠ¤íŠ¸ ìƒì„±</h2>
      <div class="input-group">
        <label>í”„ë¡¬í”„íŠ¸ (ì‹œì‘ í…ìŠ¤íŠ¸)</label>
        <input type="text" id="prompt" placeholder="ì•ˆë…•í•˜ì„¸ìš”" value="ì•ˆë…•">
      </div>

      <div class="input-group">
        <label>Temperature: <span id="temp-value">0.8</span></label>
        <div class="slider-group">
          <span>0</span>
          <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.8">
          <span>2</span>
        </div>
      </div>

      <div class="input-group">
        <label>Max Length: <span id="length-value">50</span></label>
        <div class="slider-group">
          <span>10</span>
          <input type="range" id="max-length" min="10" max="200" step="10" value="50">
          <span>200</span>
        </div>
      </div>

      <div class="controls">
        <button id="generate-btn">ğŸš€ ìƒì„±í•˜ê¸°</button>
        <button id="random-btn" class="secondary">ğŸ² ëœë¤</button>
      </div>

      <div class="output" id="output">ìƒì„±ëœ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    </div>

    <div class="panel">
      <h2>ğŸ“ ëª¨ë¸ í•™ìŠµ</h2>
      <div class="input-group">
        <label>Epochs: <span id="epochs-value">20</span></label>
        <div class="slider-group">
          <span>5</span>
          <input type="range" id="epochs" min="5" max="100" step="5" value="20">
          <span>100</span>
        </div>
      </div>
      <div class="controls">
        <button id="train-btn">ğŸš€ í•™ìŠµ ì‹œì‘</button>
        <button id="save-btn" class="secondary" disabled>ğŸ’¾ ì €ì¥</button>
        <button id="load-btn" class="secondary">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      <div class="training-progress" id="training-progress" style="display:none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text">ì¤€ë¹„ ì¤‘...</div>
      </div>
      <div class="training-log" id="training-log"></div>
    </div>

    <div class="panel">
      <h2>ğŸ”¤ í† í°í™” í…ŒìŠ¤íŠ¸</h2>
      <div class="input-group">
        <label>í…ìŠ¤íŠ¸ ì…ë ¥</label>
        <input type="text" id="tokenize-input" placeholder="í•œê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" value="ì•ˆë…•í•˜ì„¸ìš”">
      </div>
      <button id="tokenize-btn" class="secondary">í† í°í™”</button>
      <div class="tokens-display" id="tokens"></div>
    </div>

    <footer>
      <p>
        Korean Mini LM v1.0.0 |
        <a href="https://github.com/hwkim3330/sim" target="_blank">GitHub</a> |
        Pure JavaScript, No Dependencies
      </p>
      <p style="margin-top: 10px;">
        Architecture: Embedding â†’ GRU â†’ Dense (Jamo-level)
      </p>
    </footer>
  </div>

  <script src="korean-mini-lm.js"></script>
  <script src="trainer.js"></script>
  <script>
    const { JamoTokenizer } = window.KoreanMiniLM;
    const { TrainableKoreanLM, KOREAN_CORPUS, augmentCorpus } = window.KoreanMiniLMTrainer;

    // Initialize trainable model (smaller for faster training in browser)
    let model = new TrainableKoreanLM({
      embedDim: 64,
      hiddenDim: 128,
      learningRate: 0.02
    });

    const tokenizer = new JamoTokenizer();
    let trained = false;

    // Update model info
    const info = model.getInfo();
    document.getElementById('vocab-size').textContent = info.vocabSize;
    document.getElementById('param-count').textContent = (info.paramCount / 1000).toFixed(0) + 'K';
    document.getElementById('model-size').textContent = info.sizeMB + ' MB';
    document.getElementById('architecture').textContent = `${info.embedDim}â†’${info.hiddenDim}`;
    document.getElementById('status').textContent = 'âœ“ ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ';
    document.getElementById('status').classList.add('ready');

    // Temperature slider
    const tempSlider = document.getElementById('temperature');
    const tempValue = document.getElementById('temp-value');
    tempSlider.addEventListener('input', () => {
      tempValue.textContent = tempSlider.value;
    });

    // Length slider
    const lengthSlider = document.getElementById('max-length');
    const lengthValue = document.getElementById('length-value');
    lengthSlider.addEventListener('input', () => {
      lengthValue.textContent = lengthSlider.value;
    });

    // Generate button
    const generateBtn = document.getElementById('generate-btn');
    const output = document.getElementById('output');

    generateBtn.addEventListener('click', () => {
      const prompt = document.getElementById('prompt').value;
      const temperature = parseFloat(tempSlider.value);
      const maxLength = parseInt(lengthSlider.value);

      generateBtn.disabled = true;
      output.classList.add('generating');
      output.textContent = 'ìƒì„± ì¤‘...';

      setTimeout(() => {
        try {
          const result = model.generate(prompt, maxLength, temperature);
          output.textContent = result;
        } catch (err) {
          output.textContent = 'ì˜¤ë¥˜: ' + err.message;
        } finally {
          generateBtn.disabled = false;
          output.classList.remove('generating');
        }
      }, 10);
    });

    // Random button
    const randomBtn = document.getElementById('random-btn');
    const prompts = ['ì•ˆë…•', 'ì˜¤ëŠ˜', 'ë‚˜ëŠ”', 'ìš°ë¦¬', 'ì‚¬ëŒ', 'ì„¸ìƒ', 'í•˜ëŠ˜'];

    randomBtn.addEventListener('click', () => {
      document.getElementById('prompt').value = prompts[Math.floor(Math.random() * prompts.length)];
      generateBtn.click();
    });

    // Tokenize button
    const tokenizeBtn = document.getElementById('tokenize-btn');
    const tokensDisplay = document.getElementById('tokens');

    tokenizeBtn.addEventListener('click', () => {
      const text = document.getElementById('tokenize-input').value;
      const tokens = tokenizer.encode(text);

      tokensDisplay.innerHTML = tokens.map(idx => {
        const token = window.KoreanMiniLM.VOCAB[idx] || '?';
        const isSpecial = ['<PAD>', '<UNK>', '<BOS>', '<EOS>'].includes(token);
        return `<span class="token ${isSpecial ? 'special' : ''}">${token}</span>`;
      }).join('');
    });

    // Initial tokenize
    tokenizeBtn.click();

    // ========== Training ==========

    const epochsSlider = document.getElementById('epochs');
    const epochsValue = document.getElementById('epochs-value');
    epochsSlider.addEventListener('input', () => {
      epochsValue.textContent = epochsSlider.value;
    });

    const trainBtn = document.getElementById('train-btn');
    const saveBtn = document.getElementById('save-btn');
    const loadBtn = document.getElementById('load-btn');
    const trainingProgress = document.getElementById('training-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const trainingLog = document.getElementById('training-log');

    trainBtn.addEventListener('click', async () => {
      const epochs = parseInt(epochsSlider.value);

      trainBtn.disabled = true;
      trainingProgress.style.display = 'block';
      trainingLog.innerHTML = '';
      progressFill.style.width = '0%';

      // Augment corpus
      const corpus = augmentCorpus(KOREAN_CORPUS);
      progressText.textContent = `í•™ìŠµ ë°ì´í„°: ${corpus.length}ê°œ ë¬¸ì¥`;

      await new Promise(r => setTimeout(r, 100));

      try {
        const history = await model.train(corpus, epochs, (info) => {
          const pct = (info.epoch / info.total * 100).toFixed(0);
          progressFill.style.width = pct + '%';
          progressText.textContent = `Epoch ${info.epoch}/${info.total} - Loss: ${info.loss.toFixed(4)} - PPL: ${info.perplexity.toFixed(2)}`;

          const logEntry = document.createElement('div');
          logEntry.innerHTML = `Epoch ${info.epoch}: <span class="loss">Loss=${info.loss.toFixed(4)}</span> PPL=${info.perplexity.toFixed(2)}`;
          trainingLog.appendChild(logEntry);
          trainingLog.scrollTop = trainingLog.scrollHeight;
        });

        progressText.textContent = `âœ“ í•™ìŠµ ì™„ë£Œ! ìµœì¢… Loss: ${history[history.length - 1].loss.toFixed(4)}`;
        trained = true;
        saveBtn.disabled = false;

        // Update model info
        document.getElementById('status').textContent = 'âœ“ ëª¨ë¸ í•™ìŠµ ì™„ë£Œ';

      } catch (err) {
        progressText.textContent = 'ì˜¤ë¥˜: ' + err.message;
        console.error(err);
      } finally {
        trainBtn.disabled = false;
      }
    });

    // Save model
    saveBtn.addEventListener('click', () => {
      const data = model.save();
      const json = JSON.stringify(data);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'korean-mini-lm.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Load model
    loadBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const text = await file.text();
        const data = JSON.parse(text);
        model.load(data);
        trained = true;
        saveBtn.disabled = false;

        document.getElementById('status').textContent = 'âœ“ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ';
        alert('ëª¨ë¸ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
      };
      input.click();
    });
  </script>
</body>
</html>
